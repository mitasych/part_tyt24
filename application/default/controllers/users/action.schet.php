<?php$rus = array('января', 'февраля', 'марта', 'апреля', 'мая', 'июня', 'июля', 'августа', 'сентября', 'октября', 'ноября', 'декабря');//$rowContent = strip_tags($twxt2->getContent());//var_dump($twxt2);$order = new AK_Order_Item('id', $this->params['id']); $fileContent = file_get_contents(INVOICE_DIR.'/invoiceinsert.rtf');        $rowContent = file_get_contents(INVOICE_DIR.'/row.txt');        $settings = new AK_Order_Settings();        $fileContent = str_replace('XXXXX1', $settings->get('organization'), $fileContent);        $fileContent = str_replace('XXXXX2', $settings->get('uraddr'), $fileContent);        $fileContent = str_replace('XXXXX3', $settings->get('factaddr'), $fileContent);        $fileContent = str_replace('XXXXX4', $settings->get('telfax'), $fileContent);        $fileContent = str_replace('XXXXX5', $settings->get('inn'), $fileContent);        $fileContent = str_replace('XXXXX6', $settings->get('kpp'), $fileContent);        $fileContent = str_replace('XXXXX7', $settings->get('receiver'), $fileContent);        $fileContent = str_replace('XXXXX8', $settings->get('receiverschet'), $fileContent);        $fileContent = str_replace('XXXXX9', $settings->get('bik'), $fileContent);        $fileContent = str_replace('XXXX10', $settings->get('receiverbank'), $fileContent);        $fileContent = str_replace('XXXX11', $settings->get('schet'), $fileContent);        $fileContent = str_replace('XXXX12', $order->number, $fileContent);        $fileContent = str_replace('XXXX13', date('d/m/Y'), $fileContent);        $fileContent = str_replace('XXXX14', $order->zaku, $fileContent);        $fileContent = str_replace('XXXX15', $order->platu, $fileContent);        $fileContent = str_replace('XXXX19', $settings->get('gendirector'), $fileContent);        $fileContent = str_replace('XXXX20', $settings->get('glavbuh'), $fileContent);        $fileContent = str_replace('DDDDD55', $settings->get('primechanie'), $fileContent);        $_cnt = 0;        $_totalcount = 0;        $_totalprice = 0;        $_types = AK_Order_ZakazTypes::getPriceList();        $_rows = '';        if ($order->id) {            $tpArray = $order->getTotalPrices();        }        else {            $tpArray = AK_Order_Basket::getTotalPrices();        }        foreach ($tpArray as $_item) {            $_cnt++;            $addinfo = '';            if ($_item['type'] == AK_Order_ZakazTypes::BASE_ITEM) {                $addinfoA = array();                foreach ($order->getZakazList() as $_z) {                    if ($_z->typeId == $_item['type']) {                        $addinfoA[] = $_z->text;                    }                }                $addinfo = ' '.implode(', ',$addinfoA);            }            $currentRowContent = str_replace('TTTT1', $_cnt, $rowContent);            $currentRowContent = str_replace('TTTT2', $_types[$_item['type']].$addinfo, $currentRowContent);            $currentRowContent = str_replace('TTTT3', $_item['count'], $currentRowContent);            $currentRowContent = str_replace('TTTT4', (null === $_item['price'])?'':($_item['price'].',00'), $currentRowContent);            $currentRowContent = str_replace('TTTT5', $_item['pricecnt'].',00', $currentRowContent);            $_rows.=$currentRowContent;            $_totalcount = $_totalcount + $_item['count'];            $_totalprice = $_totalprice + $_item['pricecnt'];        }        $fileContent = str_replace('INSERTROWSHERE', $_rows, $fileContent);        $fileContent = str_replace('SSSSS1', $_totalcount, $fileContent);        $fileContent = str_replace('XXXX17', $_totalprice.',00', $fileContent);        $fileContent = str_replace('XXXX18', AK_Common_Functions::num2str($_totalprice.',00'), $fileContent);        // $tmpfname = tempnam(INVOICE_DIR."/tmp", "INV_BEZNAL_");        // $handle = fopen($tmpfname, "w");        // fwrite($handle, iconv("UTF-8", "CP1251", $fileContent));        // fclose($handle);//$fileContent = str_replace('XXXTEXT2XXX', $rowContent, $fileContent);//$tmpfname = tempnam(INVOICE_DIR."/tmp", "DOG_");//$handle = fopen($tmpfname, "w");//fwrite($handle, iconv("UTF-8", "CP1251", $fileContent));//fwrite($handle, $fileContent);//fclose($handle);header('Content-Type: application/rtf');header("Content-Disposition:attachment;filename=invoice_".$order->number.".rtf");//readfile($tmpfname);echo iconv("UTF-8", "CP1251", $fileContent);//echo $fileContent;//echo iconv("CP1251", "UTF-8", $fileContent);die;unlink($tmpfname);exit();