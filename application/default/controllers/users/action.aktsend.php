<?phpprint 'ff';die();$rus = array('января', 'февраля', 'марта', 'апреля', 'мая', 'июня', 'июля', 'августа', 'сентября', 'октября', 'ноября', 'декабря');$fileContent = file_get_contents(UPLOAD_TEMPLATE.'/akt.rtf');$fileContent = iconv("UTF-8", "CP1251", $fileContent);$twxt2 = new AK_Article_Item();//$twxt2->loadByRewriteName('monitoringdogovor');$rowContent = strip_tags($twxt2->getContent());//var_dump($twxt2);$order = new AK_Order_Item('id', $this->params['id']);$fileContent = str_replace('XXXXX1', $order->number, $fileContent);$fileContent = str_replace('XXXXX2', date('d.m.Y', $order->dateCreated), $fileContent);$settings = new AK_Order_Settings();$fileContent = str_replace('XXXX19', $settings->get('gendirector'), $fileContent);$fileContent = str_replace('XXXX20', $settings->get('glavbuh'), $fileContent);//var_dump($settings->get('adminemailforcopies'));// инфо о клиенте    $fileContent = str_replace('XXX22', $this->_user->dolj.' __________ '.$this->_user->df.' '.$this->_user->di.' '.$this->_user->do, $fileContent);    $fileContent = str_replace('XXX21', 'Телефон/Email: '.$this->_user->phone.' '.$this->_user->email, $fileContent);    $fileContent = str_replace('XXX20', 'ИНН/КПП: '.$this->_user->innogrn, $fileContent);    $fileContent = str_replace('XXX19', $this->_user->uraddress, $fileContent);    $fileContent = str_replace('XXX18', $this->_user->organization, $fileContent); $fileContent = str_replace('XXX17', $settings->get('gendirector'), $fileContent);//$fileContent = str_replace('XXX16', 'Техническая поддержка: '.$settings->get('adminemailforcopies'), $fileContent);$fileContent = str_replace('XXX15', $settings->get('telfax'), $fileContent);// выбор мыла в зависимости от раздела $fileContent = str_replace('XXX14', $settings->get('adminemailforcopies'), $fileContent);$fileContent = str_replace('XXX13', $settings->get('inn').'/'.$settings->get('kpp'), $fileContent);$fileContent = str_replace('XXX12', $settings->get('uraddr'), $fileContent);$fileContent = str_replace('XXX11', $settings->get('organization'), $fileContent);//var_dump($settings->get('factaddr'));if (!empty($this->_user->dn)) {    $fileContent = str_replace('XXX10', 'доверенности №'.$this->_user->dn.' от '.$this->_user->dot, $fileContent);}else {    $fileContent = str_replace('XXX10', 'устава', $fileContent);}$fname=$this->_user->di;$sname=$this->_user->do;$f=$fname[0];$s=$sname[0];$name=$this->_user->dfr;//$name=$this->_user->dfr.' '.$f.'. '.$s.'.';// в лице Фамилия И.О.$fileContent = str_replace('XXX9', $this->_user->dfr, $fileContent);// инфо о клиенте        $rowContent = file_get_contents(INVOICE_DIR.'/row.txt');        $_cnt = 0;        $_totalcount = 0;        $_totalprice = 0;        $_types = AK_Order_ZakazTypes::getPriceList();        $_rows = '';        $tpArray = $order->getTotalPrices();               foreach ($tpArray as $_item) {            $_cnt++;            $addinfo = '';            if ($_item['type'] == AK_Order_ZakazTypes::BASE_ITEM) {                $addinfoA = array();                foreach ($order->getZakazList() as $_z) {                    if ($_z->typeId == $_item['type']) {                        $addinfoA[] = $_z->text;                    }                }                $addinfo = ' '.implode(', ',$addinfoA);            }            $currentRowContent = str_replace('TTTT1', $_cnt, $rowContent);            $currentRowContent = str_replace('TTTT2', $_types[$_item['type']].$addinfo, $currentRowContent);            $currentRowContent = str_replace('TTTT3', $_item['count'], $currentRowContent);            $currentRowContent = str_replace('TTTT4', (null === $_item['price'])?'':($_item['price'].',00'), $currentRowContent);            $currentRowContent = str_replace('TTTT5', $_item['pricecnt'].',00', $currentRowContent);            $_rows.=$currentRowContent;            $_totalcount = $_totalcount + $_item['count'];            $_totalprice = $_totalprice + $_item['pricecnt'];        }        $fileContent = str_replace('INSERTROWSHERE', $_rows, $fileContent);        // $fileContent = str_replace('SSSSS1', $_totalcount, $fileContent);         $fileContent = str_replace('XXXXX7', $_totalprice.',00', $fileContent);         $fileContent = str_replace('XXXXX8', AK_Common_Functions::num2str($_totalprice.',00'), $fileContent);//$fileContent = str_replace('XXXTEXT2XXX', $rowContent, $fileContent);//$tmpfname = tempnam(INVOICE_DIR."/tmp", "DOG_");//$handle = fopen($tmpfname, "w");//fwrite($handle, iconv("UTF-8", "CP1251", $fileContent));//fwrite($handle, $fileContent);//fclose($handle);header('Content-Type: application/rtf');header("Content-Disposition:attachment;filename=akt_".$order->number.".rtf");//readfile($tmpfname);echo iconv("UTF-8", "CP1251", $fileContent);//echo $fileContent;//echo iconv("CP1251", "UTF-8", $fileContent);die;unlink($tmpfname);exit();